<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>World Point</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />

  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
    }
    body {
      cursor: crosshair;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  function cb() {}
</script>
  
<script>
  /* ================= CONFIG ================= */
  const API_URL = "https://script.google.com/macros/s/AKfycbw--oVxd3SEI94d83PMmV-DDwVJwDNOaP13XYkg3Fr_siqC7BituPAZxHnungrezDqtYQ/exec";
  /* ========================================== */

  const map = L.map("map", {
    worldCopyJump: true
  }).setView([20, 0], 2);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "Â© OpenStreetMap"
  }).addTo(map);

  let locked = localStorage.getItem("locked");

  /* ===== LOAD ALL POINTS (JSONP) ===== */
  function loadPoints(data) {
    data.forEach(p => {
      L.circleMarker([p[0], p[1]], {
        radius: 6
      }).addTo(map);
    });
  }

  const loadScript = document.createElement("script");
  loadScript.src = API_URL + "?action=get&callback=loadPoints";
  document.body.appendChild(loadScript);

  /* ===== SAVE POINT (JSONP) ===== */
  function savePoint(lat, lng) {
    const s = document.createElement("script");
    s.src = API_URL + `?action=add&lat=${lat}&lng=${lng}&callback=cb`;
    document.body.appendChild(s);
  }

  /* ===== CLICK LOGIC ===== */
  map.on("click", e => {
    if (locked) return;

    const { lat, lng } = e.latlng;

    L.circleMarker([lat, lng], {
      radius: 8
    }).addTo(map);

    savePoint(lat, lng);

    localStorage.setItem("locked", "1");
    locked = true;
  });
</script>

</body>
</html>
